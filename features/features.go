package features

import (
	"reflect"
)

// Taken from https://docs.google.com/spreadsheets/d/1CfTEmDsjnuh_flWhSFVZ6wqWR7m7egeyVD6BXppgCyE/edit#gid=1074788665

// Default global checklist.
// Helper template function for randomized testing.
var List = Checklist{}

func SumCategories(checklist interface{}) map[string]int {
	categoryCounts := make(map[string]int)

	checklistValue := reflect.ValueOf(checklist)
	checklistType := checklistValue.Type()

	for i := 0; i < checklistType.NumField(); i++ {
		field := checklistType.Field(i)
		fieldValue := checklistValue.Field(i)

		if fieldValue.Kind() == reflect.Struct {
			// Nested struct, recursively process
			// Don't need a supported check, since they already have "Used"
			nestedCounts := SumCategories(fieldValue.Interface())
			for category, count := range nestedCounts {
				categoryCounts[category] += count
			}
		} else {
			// Check for the "category" tag and increment count if true
			if category, ok := field.Tag.Lookup("category"); ok && fieldValue.Bool() {
				categoryCounts[category]++
			} else {
				categoryCounts["Uncategorized"]++
			}
		}
	}

	return categoryCounts
}

type Checklist struct {
	// TODO: Check this with Rahul? Do we care about backends for this report?
	Sources struct {
		Used      bool `category:"Supported"`
		FromEnv   bool
		PG        bool `category:"Supported"`
		SQLServer bool
		MySQL     bool
		Mongo     bool
	}

	Tables struct {
		Used bool
		/* // These are actions on MD, not features:
		TrackModels bool
		TrackForeignKeys bool
		TrackFunctions bool
		*/
		CommentsOnModels bool
		EnumTables       bool
		ApolloFederation bool
	}

	Relationships struct {
		Used                               bool
		LocalRelationshipWithForeignKey    bool
		LocalRelationshipWithoutForeignKey bool
		RemoteRelationship                 bool
	}

	QueriesAndMutations struct {
		Used bool
		// AutoGeneratedQueryFeatures bool // N/A?
		// QueryList                  bool // N/A?
		QueryByPrimaryKey bool
		DistinctOn        bool
		UsesWhere         bool
		// It may be difficult to determine this from metadata...
		Where struct {
			BasicUsage           bool
			WithBoolExpression   bool
			Operators            bool
			AggregateExpressions bool
		}
		Pagination          bool
		Limit               bool
		Offset              bool
		OrderBy             bool
		Aggregate           bool
		SimpleObjectQueries struct {
			Used                   bool
			ScalarIntegerAndText   bool
			ScalarJSON             bool
			NestedObjects          bool
			AggregateNestedObjects bool
		}
		BoolExpressions bool
		Introspection   bool
		RunSQL          bool // N/A?
		Permissions     struct {
			Used              bool
			ColumnPermisisons bool
			PermissionRules   bool
		}
	}

	Actions struct {
		Used      bool
		Queries   bool
		Mutations bool
		Types     struct {
			Used              bool
			CustomTypes       bool
			CustomScalarTypes bool
		}
		HttpConfiguration struct {
			Used                 bool
			ConfiguredEndpoints  bool
			URLTemplating        bool
			RequestMethod        bool
			StaticHeaders        bool
			DynamicHeaders       bool
			ForwardClientHeaders bool
		}
		AsyncActions bool
		/* /// Not part of configuration
		* Open API Import
			* Single Import
			* bulk import
			* error handling during import
			* support yaml & JSON
		* Code Gen
			* Support multiple programming languages & frameworks
		* Derive Actions
		*/
		BasicPermissions bool
		Relationships    struct {
			Used           bool
			ActionToDB     bool
			ActionToRS     bool
			ActionToAction bool
		}
		Transforms struct {
			Used              bool // Subsumes Kriti Feature.
			RequestTransforms struct {
				Used           bool
				ContextObjects bool
				RequestMethod  bool
				RequestURL     bool
				RequestBody    bool
			}
			ResponseTransforms struct {
				Used           bool
				ContextObjects bool
				DebuggingMode  bool
			}
			PayloadTransforms struct {
				Used                   bool
				ResponseBodyTransforms bool
			}
		}
		// * Async Action logs cleanup (?) // What's this?
	}

	RemoteSchemas struct {
		Used          bool
		Configuration struct {
			Used           bool
			FromEnv        bool
			Timeout        bool
			Headers        bool
			DynamicHeaders bool
		}
		Relationships struct {
			Used            bool
			ToDatabase      bool
			ToRemoteSchema  bool
			ArgumentPresets bool
		}
		Permissions bool
		BypassAuth  bool
	}

	EventTriggers struct {
		Used  bool
		Types struct {
			Insert bool
			Update bool
			Delete bool
			// Via console: N/A?
			ColumnSpecificUpdates bool
		}
		TriggerProtocols struct {
			Webhook bool
		}
		// * Auto Cleanup Event Logs (Make sure event logs are cleared periodically): N/A?
		RequestTransforms struct {
			UsesRequestTransforms bool
			Headers               bool
			RequestMethod         bool
			RequestURL            bool
			RequestBody           bool
			Context               bool
		}
		ResponseTransforms struct {
			UsesResponseTransforms bool
		}
		PayloadTransform struct {
			ResponseBodyTransforms bool
		}
		RetryLogicConfiguration bool
		/* // N/A?
		* Simulation
			* Event triggers can be tested by manually triggering from console
		* Codegen
		* Observability
		* Performance
		*/
	}

	Authentication struct {
		Used bool
		JWTs struct {
			UsesJWTs bool
			Secret   bool
			JWK      bool
		}
		Webhook              bool
		AdminRole            bool
		UnauthorisedAccess   bool
		MultipleAdminSecrets bool
		MultipleJWTs         bool
	}

	Authorization struct {
		Used                      bool
		RoleFromSessionVariable   bool
		RoleBasedSchemeGeneration bool
		ConfigureRowPermissions   bool
		ColumnPermissions         bool
		AggregationPermissions    bool
		RowFetchLimit             bool
		RootFieldVisibility       bool
		ColumnPresets             bool
		BackendOnlyMutations      bool
		PermissionsOperators      bool
		// PermissionsSummary (on Console): N/A?
	}

	Relay struct {
		Used    bool
		Queries struct {
			UsesQueries                 bool
			ConnectionObjectsNodesEdges bool
		}
		Subscriptions bool
		Mutations     bool
	}

	RESTifiedEndpoints struct {
		Used                     bool
		BasicGraphql             bool
		ArgumentsFromPayloadBody bool
		ArgumentsFromURLParams   bool
		DifferentHTTPMethods     bool
		// * RESTified endpoint playground (like GraphiQL UI, to test REST endpoints): N/A?
	}

	/* // Not able to be detected from metadata:
	### Caching
	* Basic Caching with @cached
	* With Custom TTL @cached(ttl: 120)
	* forcing a refresh @cached(refresh: true)
	*/

	AllowLists struct {
		Used                                    bool
		ConfigureQueryCollectionsWithRoleAccess bool
		MultipleQueryColectionsAndRoles         bool
		CachingMetrics                          bool // ??
		EnterpriseSuppport                      struct {
			UsesEnterpriseSuppport    bool
			CustomRedisConfigurations bool
		}
	}

	APILimits struct {
		Used        bool
		RateLimits  bool
		DepthLimits bool
		NodeLimits  bool
		TimeLimits  bool
		BatchLimits bool
	}

	// How to detect this?
	DynamicEnvironmentVariables struct {
		Used                         bool
		ZeroDowntimeSecretResolution bool
	}

	/* // N/A?
	### Other
	* Metadata Consistency
	* Schema Registry
	* Federation
		* Apollo Federation
	*/

	// The following may need to be detected in telemetry data:
	// --------------------------------------------------------

	Subscriptions struct {
		Used bool
	}

	Observability struct {
		Used             bool
		OpenTelemetry    bool
		MetricsURL       bool
		TracePropogation bool
		Headers          bool
		Attrubutes       bool
		APMIntegrations  struct {
			Prometheus   bool
			Datadog      bool
			NewRelic     bool
			AzureMonitor bool
		}
		QueryTags bool
	}
}
